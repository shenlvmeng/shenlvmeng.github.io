
<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><style>*{margin:0;padding:0;}.locations,div.panel{color:#fff;position:absolute}.hide .curr,.locations.hide{opacity:0}.close,.locations,div.panel{position:absolute}.city,.close{cursor:pointer}#map,body,html{width:100%;height:100%;overflow:hidden;margin:0}div.panel{top:10px;left:20px;width:210px;font:lighter 14px/1.8 'Helvetica Neue','Microsoft Yahei',sans-serif}.panel div{background-color:rgba(63,81,181,.5);margin-bottom:10px;padding-left:5px;border-radius:2px}.panel .curr{background-color:rgba(244,67,54,.5);transition:opacity 1s ease-in-out}.locations{bottom:20px;left:50%;min-width:320px;padding:10px 20px;border-radius:2px;transform:translateX(-50%);font-size:14px;font-weight:lighter;background-color:rgba(63,81,181,.5);box-sizing:border-box;z-index:100;transition:opacity ease-in-out .5s}.locations>div{line-height:1.5}.locations span{line-height:1}.city{text-decoration:underline}.close{right:5px;color:#fdfdfd;top:5px;font-size:18px}.shortcut{width:70px;padding:3px 3px 0 3px;font-family:PingFang SC, Helvetica Neue, Helvetica, Microsoft Yahei;}.shortcut img{max-width:100%;max-height:100%;vertical-align:middle;z-index:500;}.BMapLabel{border:1px solid #eee !important;box-shadow:0 1px 6px rgba(0,0,0,.2);}.shortcut::before{content:'';position:absolute;left:32px;bottom:-5px;width:10px;height:10px;transform:rotate(45deg);background:#fff;z-index:-1;}.shortcut p{padding:5px 0;color:#666;text-align:center;font-weight:600;}.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(55,55,55,.6);z-index:1000;display:flex;align-items:center;justify-content:space-around;padding:30px;transition:opacity .5s;}.hidden{opacity:0;pointer-events:none;}.image-original{max-width:50%;}.image-original img{max-height:520px;max-width:100%;}.image-info p{color:#fff;font-size:20px;line-height:4;font-weight:100;}.image-info .title{color:#eee;font-weight:400;}.hideBtn{position:absolute;right:40px;top:20px;font-size:30px;color:#fff;cursor:pointer;}.toggle-images{position:absolute;top:40px;right:10px;padding:6px 15px;font-size:12px;color:#fff;border-radius:4px;cursor:pointer;}.toggle-images.info{background:#16be6b;}.toggle-images.error{background:#ed4040;}
</style><title>我的骑行轨迹</title></head><body><div id="map"></div><div class="panel hide" id="panel"><div>总里程：<span id="distance"></span> km</div><div>总时间：<span id="time"></span></div><div class="curr">当次里程：<span id="curr_distance"></span> km</div><div class="curr">运动时间：<span id="curr_time"></span></div><div class="curr">出发时间：<span id="start_time"></span></div></div><div class="locations">我去过的地方<div class="province">省份：<span id="provinces"></span></div><div class="cities">城市：<span id="cities"></span></div><span class="close" id="close">×</span></div><div class="modal hidden" id="modal">
    <div class="image-original">
        <img src="" id="image">
    </div>
    <div class="image-info">
        <p class="title">详情</p>
        <p>经度：<span id="longitude"></span> N</p>
        <p>纬度：<span id="latitude"></span> E</p>
        <p>海拔：<span id="altitude"></span>m</p>
        <p>摄于：<span id="create-time"></span></p>
    </div>
    <div class="hideBtn" id="hide">×</div>
</div>
<div id="toggle" class="toggle-images error">关闭图片展示</div>
</body><script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script><script src="https://api.map.baidu.com/api?v=2.0&ak=K4lj4WauSIagEIiRkVY0lVt6IGgR6WM4"></script>
<script>!function(){var e=0,n=0,t=null,a=Array.apply(null,Array(39)).map(function(e,n){return n+".json"}),i=[],o=[];function r(e){return document.getElementById(e)}function c(e){var n=e.city,t=e.province;t&&-1===i.indexOf(t)&&i.push(t),n&&-1===o.indexOf(n)&&o.push(n),r("provinces").innerText=i.map(function(e){return e.slice(0,-1)}).join(", "),r("cities").innerHTML=o.map(function(e){return"<span class='city'>"+e.slice(0,-1)+"</span>"}).join(", ")}function s(e){return e>31536e3?~~(e/315636e3)+"年 "+s(e%31536e3):e>2592e3?~~(e/2592e3)+"月 "+s(e%2592e3):e>86400?~~(e/86400)+"天 "+s(e%86400):e>3600?~~(e/3600)+"h "+s(e%3600):e>60?~~(e/60)+"m "+s(e%60):e.toFixed(0)+"s"}function d(){t&&(t.setStrokeColor("#3a6bdb"),r("panel").className+=" hide",t=null)}window.l=new BMap.Map("map");l.centerAndZoom('北京'),l.addControl(new BMap.MapTypeControl({mapTypes:[BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]})),l.enableScrollWheelZoom(!0),l.addEventListener("click",function(e){d()}),r("cities").addEventListener("click",function(e){(e.target.className="city")&&l.centerAndZoom(e.target.innerText)}),r("close").addEventListener("click",function(e){e.target.parentNode.className+=" hide"}),function i(){var o,p,u;a.length&&(o=a.shift(),p=function(a){a&&i();try{var o=JSON.parse(a);e+=+o.distance,n+=+o.time;var p=o.points.map(function(e){return new BMap.Point(e.lng,e.lat)}),u=new BMap.Polyline(p,{enableMassClear:false});u.metadata={distance:o.distance,time:o.time,startTime:o.startTime},u.addEventListener("click",function(e){d(),e.target.setStrokeColor("#f44336");var n=e.target.metadata;r("curr_distance").innerText=n.distance,r("curr_time").innerText=s(n.time),r("start_time").innerText=n.startTime,r("panel").className="panel",t=e.target,e.domEvent.stopPropagation()}),l.addOverlay(u),(new BMap.Geocoder).getLocation(p[0],function(e){c(e.addressComponents)}),(new BMap.Geocoder).getLocation(p[~~(p.length/2)],function(e){c(e.addressComponents)}),(new BMap.Geocoder).getLocation(p[p.length-1],function(e){c(e.addressComponents)}),r("distance").innerText=e.toFixed(3),r("time").innerText=s(n)}catch(e){console.warn(e)}},(u=new XMLHttpRequest).open("GET",o,!0),u.onreadystatechange=function(){4===u.readyState&&200===u.status&&p(u.response)},u.send())}()}();</script>
<script>!function(){const t=3.141592653589793,n=52.35987755982988;function a(n,a){const s=6378245,h=.006693421622965943;let i=function(n,a){let s=2*n-100+3*a+.2*a*a+.1*n*a+.2*Math.sqrt(Math.abs(n));return s+=2*(20*Math.sin(6*n*t)+20*Math.sin(2*n*t))/3,s+=2*(20*Math.sin(a*t)+40*Math.sin(a/3*t))/3,s+=2*(160*Math.sin(a/12*t)+320*Math.sin(a*t/30))/3}(a-105,n-35),o=function(n,a){let s=300+n+2*a+.1*n*n+.1*n*a+.1*Math.sqrt(Math.abs(n));return s+=2*(20*Math.sin(6*n*t)+20*Math.sin(2*n*t))/3,s+=2*(20*Math.sin(n*t)+40*Math.sin(n/3*t))/3,s+=2*(150*Math.sin(n/12*t)+300*Math.sin(n/30*t))/3}(a-105,n-35);const M=n/180*t;let r=Math.sin(M);r=1-h*r*r;const l=Math.sqrt(r);return{lat:i=180*i/(s*(1-h)/(r*l)*t),lon:o=180*o/(s/l*Math.cos(M)*t)}}function s(t,n){if(h(t,n))return{lat:t,lon:n};const s=a(t,n);return{lat:t+s.lat,lon:n+s.lon}}function h(t,n){return n<72.004||n>137.8347||(t<.8293||t>55.8271)}window.wgs2bd=function({lat:t,lon:a}){let h=s(t,a);return function(t,a){const s=a,h=t,i=Math.sqrt(s*s+h*h)+2e-5*Math.sin(h*n),o=Math.atan2(h,s)+3e-6*Math.cos(s*n),M=i*Math.cos(o)+.0065;return{lat:i*Math.sin(o)+.006,lon:M}}(h.lat,h.lon)}}();</script>
<script>
    !function() {
        let i = 0;
        let showImages = true;
        const imageInfo = [];
        function $(query) {
            return document.querySelector(query);
        }
        function _(query) {
            return document.querySelectorAll(query);
        }
        function convertLocation(pos) {
            return pos[0] + pos[1] / 60 + pos[2] / 3600;
        }
        function get() {
            const image = new Image();
            image.src = `./images/${i}.jpg`;
            image.onerror = (err) => {
                draw();
            }
            image.onload = () => {
                EXIF.getData(image, function() {
                    imageInfo.push({
                        vertical: this.width === 600,
                        time: EXIF.getTag(this, 'DateTime'),
                        altitude: EXIF.getTag(this, 'GPSAltitude').valueOf(),
                        latitude: convertLocation(EXIF.getTag(this, 'GPSLatitude')),
                        longitude: convertLocation(EXIF.getTag(this, 'GPSLongitude'))
                    })
                    get(++i);
                });
            }
        }
        get();
        function draw() {
            console.log(imageInfo)
            imageInfo.forEach((m, index) => {
                const correctPoint = wgs2bd({lat: m.latitude, lon: m.longitude});
                const point = new BMap.Point(correctPoint.lon, correctPoint.lat);
                const text = `<div class="shortcut" title="摄于${m.time}" id="${index}">
                    <img src='./images/${index}.jpg' />
                    <p>海拔 ${m.altitude.toFixed(1)}m</p>
                </div>`;
                const label = new BMap.Label(text, {
                    position: point,
                    offset: new BMap.Size(-38, m.vertical ? -134 : -95)
                });
                l.addOverlay(label);
            });
        }
        $('#map').addEventListener('click', e => {
            let t = e.target;
            if (!t.id) t = t.parentNode;
            if (t.id && t.id < imageInfo.length) {
                const info = imageInfo[+t.id];
                $('#modal').classList.remove('hidden');
                $('#altitude').innerText = info.altitude.toFixed(3);
                $('#longitude').innerText = info.longitude.toFixed(5);
                $('#latitude').innerText = info.latitude.toFixed(5);
                $('#image').src = `./images/${t.id}.jpg`;
                $('#create-time').innerText = `${info.time.slice(0, 11).replace(/:/g, '-')}${info.time.slice(11)}`;
            }
        });
        $('#hide').addEventListener('click', () => {
            $('#modal').classList.add('hidden');
        });
        $('#toggle').addEventListener('click', function() {
            showImages = !showImages;
            this.innerText = showImages ? '关闭图片展示' : '开启图片展示';
            this.className = showImages ? 'toggle-images error' : 'toggle-images info';
            showImages ? draw() : l.clearOverlays();
        });
    }()
</script>
</html>
