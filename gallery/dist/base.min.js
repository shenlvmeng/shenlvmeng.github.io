"use strict";function loadFile(t,i){if("function"!=typeof fetch){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==e.readyState)if(200==e.status){var t=void 0;try{t=JSON.parse(e.responseText)}catch(i){t={},console.warn(i)}i(t)}else console.warn("Error",e.statusText)},e.open("GET",t,!0),e.send()}else fetch(t).then(function(t){return t.json()}).then(function(t){return i(t)})}var res=void 0,tag_list={};loadFile("./dist/gallery_info.json",function(t){console.log(t.name+": "+t.description),console.log("Author: "+t.author);for(var i=t.content.length,e=void 0,n=0;n<i;n++)!function(i){var e=Math.floor(t.content[i].date/1e4);e<=2012&&(e="~2012"),tag_list[e+=""]?tag_list[e].push(i):tag_list[e]=[i],t.content[i].tags.forEach(function(t){tag_list[t]?tag_list[t].push(i):tag_list[t]=[i]})}(n);e=Object.keys(tag_list);var s={template:'<div id="photos" @click="changeView($event)">        <figure v-for="item in items" :id="item.id">          <img :src="(!! lazylist && lazylist[item.id]) ?  stupid : item.path" :class="{blankimg: (!! lazylist && lazylist[item.id])}" :ref="stupidPrefix + item.id">          <aside><span>{{item.desc}}</span></aside>        </figure>      </div>',props:["factors"],data:function(){return{lazylist:Array.apply(null,new Array(i)).map(function(){return!0}),stupid:"./assets/img/blank.jpg",stupidPrefix:"i_"}},mounted:function(){this.lazyload(),window.addEventListener("scroll",this.lazyload),window.addEventListener("resize",this.lazyload)},methods:{changeView:function(t){this.$emit("toinfo",t.target.parentElement.id)},lazyload:function(t){if([]!==this.lazylist){var i=(window.innerHeight||document.documentElement.clientHeight)+(document.documentElement.scrollTop||document.body.scrollTop||window.pageYOffset),e=this;this.items.forEach(function(t){0!=e.lazylist[t.id]&&e.$refs["i_"+t.id][0].parentElement.offsetTop<i&&e.lazylist.splice(t.id,1,!1)}),-1==this.lazylist.indexOf(!0)&&(this.lazylist=[])}}},computed:{items:function(){var n=[],s={},a=Array.apply(null,Array(i)).map(function(t,i){return i});this.factors.forEach(function(t){partialArr=e.filter(function(i){return-1!=i.search(t)}).reduce(function(t,i){return t.concat(tag_list[i])},[]),a=_.intersection(partialArr,a)});for(var o=0,r=a.length;o<r;o++)void 0==s[a[o]]&&(s[a[o]]=1,n.push({id:a[o],desc:t.content[a[o]].info,path:"./assets/img/"+a[o]+"."+t.content[a[o]].type}));return n}},watch:{items:function(t){if([]!==this.lazylist){var i=this;t.forEach(function(t){i.lazylist.splice(t.id,1,!1)})}}}},a={template:'<div id="display" :style="{top: scrolltop}">      <aside @click="quit">×</aside>      <figure><img :src="path"></figure>      <div id="imginfo">        <p><span class="vertical-center">{{info}}</span></p>        <div id="imgtags" @click="chooseTag($event)">          <span v-for="tag in tags">{{tag}}</span>        </div>        <div id="imgrelated" class="clearfix" @click="choosePic($event)">          <div>相似的图片：</div>          <img v-for="relate in relates" :src="relate.path" :id="relate.id">        </div>      </div>    </div>',props:["pid"],data:function(){return{scrolltop:"50px",id:this.pid}},created:function(){var t=void 0!==window.pageXOffset,i="CSS1Compat"===(document.compatMode||""),e=t?window.pageYOffset:i?document.documentElement.scrollTop:document.body.scrollTop;this.scrolltop=Math.max(50,e)+"px"},methods:{chooseTag:function(t){this.$emit("revisetag",t.target.innerHTML)},choosePic:function(t){var i=parseInt(t.target.id);i>=0&&(this.id=i)},quit:function(){this.$emit("revisetag")}},computed:{path:function(){return"./assets/img/"+this.id+"."+t.content[this.id].type},info:function(){return t.content[this.id].info},tags:function(){return t.content[this.id].tags},relates:function(){for(var i=this.tags,e=[parseInt(this.id)],n=0;n<4;n++){for(var s=tag_list[i[_.random(i.length-1)]],a=_.random(s.length-1),o=0;-1!=e.indexOf(s[a]);)if(s=tag_list[i[_.random(i.length-1)]],a=_.random(s.length-1),++o>20)return e.shift(),e.map(function(i){return"./assets/img/"+i+"."+t.content[i].type});e.push(s[a])}return e.shift(),e.map(function(i){return{path:"./assets/img/"+i+"."+t.content[i].type,id:i}})}}};new Vue({data:{filter:"",pid:0,currView:"picwall"},mounted:function(){var t=this,i=Array.prototype.slice.call(document.getElementsByClassName("list-item"));i.forEach(function(e){e.addEventListener("click",function(e){if(i.forEach(function(t){t.children[1].style.display=""}),""==t.children[1].style.display?t.children[1].style.display="block":t.children[1].style.display="",!e)window.event;e.cancelBubble=!0,e.stopPropagation&&e.stopPropagation()})}),window.addEventListener("click",function(){i.forEach(function(t){t.children[1].style.display=""})})},methods:{addPreface:function(){""==this.filter&&(this.filter="preface"),-1==this.factors.indexOf("preface")&&(this.filter+=",preface")},addShot:function(){""==this.filter&&(this.filter="screenshot"),-1==this.factors.indexOf("screenshot")&&(this.filter+=",screenshot")},addTag:function(t){var i=t.target.innerHTML;""==this.filter&&(this.filter=i),-1==this.factors.indexOf(i)&&(this.filter+=","+i)},toInfo:function(t){t&&(this.pid=t),this.currView="picinfo"},reviseTag:function(t){t?this.filter=t:this.currView="picwall"}},computed:{factors:function(){return this.filter.split(",",10).filter(function(t){return""!=t})}},watch:{filter:function(){this.currView="picwall"}},components:{picwall:s,picinfo:a}}).$mount("#app")});