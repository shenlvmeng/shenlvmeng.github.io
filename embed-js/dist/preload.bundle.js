!function(e){function t(n){if(s[n])return s[n].exports;var r=s[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var s={};return t.m=e,t.c=s,t.p="",t(0)}([function(e,t,s){"use strict";s(1)},function(e,t,s){"use strict";function n(e,t,s,n,o,a,c){var h=i.Network.mkGraph(100,.5,100,100,u.VLAN_MAX),l=new i.SubstrateN(h.nodes,h.links);l.findKShortestPaths();var f=new u.Simulation(l,e,t);f.dispatch(s,n,o,a,c),f.print(r)}function r(e,t,s,n){e!=t?$("#display_t").html(t-e):$("#display_t").html("--"),$("#display_s").html(e),$("#display_a").html(s),$("#display_r").html(n)}var i=s(2),u=s(3);$("#submit").on("click",function(e){e.preventDefault();var t=parseInt($("#vns").val())||10,s=parseInt($("#wins").val())||5,r=parseInt($("input[name=isinf]:checked","#panel").val())||1,i=parseFloat($("#linkrate").val())||.5,u=parseInt($("#cpu").val())||1,o=parseInt($("#bw").val())||1,a=parseInt($("#life").val())||3;n(t,s,r,i,u,o,a)})},function(e,t){"use strict";function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}(),u=function l(e){r(this,l),this.cpu=e,this.usage=[]},o=function f(e,t,s,n){r(this,f),this.src=e,this.dst=t,this.bw=s,this.vlan=n,this.usage=[]},a=function(){function e(t,s){r(this,e),this.nodes=t,this.links=s,this.nodes.forEach(function(e,t){e.id=t}),this.links.forEach(function(e,t){e.id=t})}return i(e,[{key:"sum_nodes",get:function(){return this.nodes.length}},{key:"sum_links",get:function(){return this.links.length}}],[{key:"mkGraph",value:function(e,t,s,n,r){for(var i=[],a=[],c=0;c<e;c++){var h=new u(Math.random()*s);i.push(h)}var l=new o(0,1,Math.random()*n,r);a.push(l);for(var f=2;f<i.length;f++){for(var d=!0,p=0;p<f;p++)if(Math.random()<=t){var v=new o(p,f,Math.random()*n,r);a.push(v),d=!1}if(d){var k=Math.floor(Math.random()*f);k==f&&(k-=1);var w=new o(k,f,Math.random()*n,r);a.push(w)}}var y={nodes:i,links:a};return y}}]),e}(),c=function(e){function t(e,n,i,u){r(this,t);var o=s(this,Object.getPrototypeOf(t).call(this,n,i));return o.id=e,o.state="R",o.tryCounts=0,o.life=u||1,o.revenue=o.nodes.reduce(function(e,t){return e+t.cpu},0)+o.links.reduce(function(e,t){return e+t.bw+1},0),o}return n(t,e),t}(a),h=function(e){function t(){return r(this,t),s(this,Object.getPrototypeOf(t).apply(this,arguments))}return n(t,e),i(t,[{key:"getMaxWeightedNode",value:function(e,t){var s=this,n=new Array(this.sum_nodes).fill(0);this.links.forEach(function(e){n[e.src]+=e.bw,n[e.dst]+=e.bw}),this.nodes.forEach(function(e,t){n[t]*=e.cpu});var r={id:-1,value:0};return n.forEach(function(n,i){s.nodes[i].cpu>=t&&n>r.value&&s.nodes[i].usage.indexOf(e)==-1&&(r.id=i,r.value=n)}),r.id}},{key:"alterNodeResource",value:function(e,t,s,n){if("add"===s){this.nodes[e].cpu+=t;var r=this.nodes[e].usage.indexOf(n);r!=-1&&this.nodes[e].usage.splice(r,1)}else{if("sub"!==s)throw new Error("Unknown alter node resource type!");if(this.nodes[e].cpu<t)throw new Error("Node "+e+" CPU is not enough!");this.nodes[e].cpu-=t,this.nodes[e].usage.push(n)}}},{key:"alterLinksResource",value:function(e,t,s,n){var r=this;if("add"===s)e.forEach(function(e){r.links[e].bw+=t,r.links[e].vlan+=1,r.links[e].usage.splice(r.links[e].usage.indexOf(n),1)});else{if("sub"!==s)throw new Error("Unknown alter links resource type!");if(!e.every(function(e){return r.links[e].bw>=t&&r.links[e].vlan>0}))throw new Error("Link resource not met!");e.forEach(function(e){r.links[e].bw-=t,r.links[e].vlan-=1,r.links[e].usage.push(n)})}}},{key:"findKShortestPaths",value:function(){var e=this,t=[];this.paths=[];for(var s=0;s<this.sum_nodes;s++){t.push(new Array(this.sum_nodes)),this.paths.push(new Array(this.sum_nodes));for(var n=0;n<this.sum_nodes;n++)s==n?(t[s][n]=0,this.paths[s][n]=n):(t[s][n]=1e4,this.paths[s][n]=-1)}this.links.forEach(function(s){s.src>=0&&s.dst>=0&&(t[s.src][s.dst]=1,t[s.dst][s.src]=1,e.paths[s.src][s.dst]=s.dst,e.paths[s.dst][s.src]=s.src)});for(var r=0;r<this.sum_nodes;r++)for(var i=0;i<this.sum_nodes;i++)for(var u=0;u<this.sum_nodes;u++)i!=r&&u!=r&&i!=u&&t[i][r]+t[r][u]<t[i][u]&&(t[i][u]=t[i][r]+t[r][u],this.paths[i][u]=this.paths[i][r])}}]),t}(a);t.Network=a,t.VirtualN=c,t.SubstrateN=h},function(e,t,s){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.Simulation=t.VLAN_MAX=void 0;var r=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}(),i=s(2),u=4096,o=2,a=3,c=function(){function e(t,s,r){n(this,e),this.sn=t,this.vnsPerWin=s,this.windows=r,this.counter=0,this.currSum=0,this.succRev=0,this.succCos=0,this.succSum=0,this.failSum=0,this.readyQueue=[],this.postpQueue=[],this.inQueue=[],this.indices=[]}return r(e,[{key:"mapNode",value:function(e){var t=this,s=this.readyQueue[e];if("R"!=s.state)throw new Error("Wrong state("+s.state+") of request "+s.id+"in ready queue.");for(var n=0,r=s.nodes.length;n<r;n++){var i=s.nodes[n],u=this.sn.getMaxWeightedNode(s.id,i.cpu);if(u<0||i.cpu>this.sn.nodes[u].cpu)return s.nodes.forEach(function(e){e.usage.length>0&&t.sn.alterNodeResource(e.usage[0],e.cpu,"add",s.id)}),s.tryCounts<o&&(s.tryCounts+=1,this.postpQueue.push(s),s.state="P"),-1;i.usage.push(u),this.sn.alterNodeResource(u,i.cpu,"sub",s.id)}return s.state="NF",0}},{key:"mapLink2Steps",value:function(e,t){var s=this,n=this.readyQueue[e],r=[],i=0,u=0;if("NF"!=n.state)throw new Error("Wrong state("+n.state+") of request "+n.id+"in ready queue.");for(var a=function(e,t){var a=n.links[e],c=n.nodes[a.src].usage[0],h=n.nodes[a.dst].usage[0];r=[];for(var f=function(){var e=s.sn.paths[c][h];return e==-1?(i=2,"break"):(l=s.sn.links.findIndex(function(t){return t.src==c&&t.dst==e||t.src==e&&t.dst==c}),l==-1||s.sn.links[l].bw<a.bw||s.sn.links[l].vlan<1?(i=1,"break"):(r.push(l),void(c=e)))};c!=h;){var d=f();if("break"===d)break}if(1==i)for(;1==i;){r=[],s.indices.push({index:l,src:s.sn.links[l].src,dst:s.sn.links[l].dst}),s.sn.links[l].src=-1,s.sn.links[l].dst=-1,s.sn.findKShortestPaths(),c=n.nodes[a.src].usage[0],i=0;for(var p=function(){var e=s.sn.paths[c][h];return e==-1?(i=2,"break"):(l=s.sn.links.findIndex(function(t){return t.src==c&&t.dst==e||t.src==e&&t.dst==c}),l==-1||s.sn.links[l].bw<a.bw||s.sn.links[l].vlan<1?(i=1,"break"):(r.push(l),void(c=e)))};c!=h;){var v=p();if("break"===v)break}}if(0==i)u+=a.bw*(r.length-1),console.log("Alter link resources for VN "+n.id),s.sn.alterLinksResource(r,a.bw,"sub",n.id);else if(2==i)return n.nodes.forEach(function(e){if(0==e.usage.length)throw new Error("Node resource error in link resource releasing.");s.sn.alterNodeResource(e.usage[0],e.cpu,"add",n.id)}),n.links.forEach(function(e){e.usage.length>0&&s.sn.alterLinksResource(e.usage,e.bw,"add",n.id)}),n.tryCounts<o&&(n.tryCounts+=1,s.postpQueue.push(n),n.state="P"),"break"},c=0,h=n.links.length;c<h;c++){var l,l,f=a(c,h);if("break"===f)break}for(var d=0;d<this.indices.length;d++)this.sn.links[this.indices[d].index].src=this.indices[d].src,this.sn.links[this.indices[d].index].dst=this.indices[d].dst;return this.indices=[],0==i?(this.succRev+=n.revenue,this.succCos+=u+n.revenue,this.succSum+=1,n.state="LF",0):-1}},{key:"dispatch",value:function(e,t,s,n,r){var o=this,c=Math.min(this.windows,1e3);console.log("Total time windows: "+c);for(var h=0;h<c;h++){if(console.log("Time window No."+(h+1)),!e)for(var l=0;l<this.inQueue.length;l++)this.inQueue[l].life<=h&&!function(){var e=o.inQueue[l];if("LF"!=e.state)throw new Error("Uncorrect state in inQueue!");console.log("Release resources of request "+e.id),e.nodesforEach(function(t){if(0==t.usage.length)throw new Error("Node resource error in link resource releasing.");o.sn.alterNodeResource(t.usage[0],t.cpu,"add",e.id)}),e.links.forEach(function(t){t.usage.length>0&&o.sn.alterLinksResource(t.usage,t.bw,"add",e.id)}),o.inQueue.splice(l,1)}();for(;0!=this.postpQueue.length;){var f=this.postpQueue.pop();f.state="R",this.readyQueue.push(f),this.failSum-=1}for(var d=Math.floor(Math.random()*(this.vnsPerWin+1)+1*this.vnsPerWin/2),p=0;p<d;p++){var v=Math.floor(7*Math.random()+a),k=i.Network.mkGraph(v,t,s,n,u),w=e?0:h+1+Math.floor(Math.random()*r),y=new i.VirtualN(this.counter,k.nodes,k.links,w);this.counter++,this.readyQueue.push(y)}for(this.readyQueue.sort(function(e,t){return t.revenue-e.revenue});this.readyQueue.length>0;){if("R"!=this.readyQueue[0].state)throw new Error("Request in ready queue with uncorrect state: "+this.readyQueue[0].state);0!=this.mapNode(0)?this.failSum+=1:0==this.mapLink2Steps(0,e)?e||this.inQueue.push(this.readyQueue[0]):this.failSum+=1,this.currSum+=1,this.readyQueue.shift()}}}},{key:"print",value:function(e){e(this.counter,this.currSum,this.calcAR(),this.calcRC())}},{key:"calcRC",value:function(){return this.succRev/this.succCos}},{key:"calcAR",value:function(){return 1-this.failSum/this.counter}}]),e}();t.VLAN_MAX=u,t.Simulation=c}]);